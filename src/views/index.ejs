<!DOCTYPE html>
<html>
<head>
    <title>Database Connection Test</title>
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>
    <div class="container">

        <div>

        </div>
        
        <div id="testLogin">
            <h1>Login</h1>
            <div class="login-container">
                <form action="/login" method="POST">
                    <div class="row">
                        <div class="col-25">
                            <label for="email" >Email:</label>
                        </div>

                        <div class="col-75">
                            <input type="text" id="email" name="email"  required>
                        </div>
                    </div>
                    
                    <br>


                    <div class="row">
                        <div class="col-25">
                            <label for="password" >Password:</label>
                        </div>

                        <div class="col-75">
                            <input type="password" id="password" name="password" required>
                        </div>
                    
                    <br>
                    <div class="row">
                        <button type="submit">Login</button>
                    </div>
                    
                </form>
            </div>
        </div>
        

        <div id="testAuthTokens">
            <div class="flex">
                <h1>Logged in: </h1>
                    <% if (user) { %>
                    <h1>True</h1>
                    <% } else { %>
                    <h1>False</h1>
                    <% } %>
            </div>
            
            <% if (user) { %>
                <p> <%= user.email %> </p>
                <p> <%= user.first_name %> </p>
                <p> <%= user.last_name %> </p>

                <form action="/logout" method="POST">
                    <button >Logout</button>
                </form>
                
            <% } else { %>
                <p> Not logged in </p>
            <% } %>
        </div>



        <script>
            document.getElementById('testButton').addEventListener('click', async () => {
                // Show loading indicator
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('statusContainer').innerHTML = '';
                document.getElementById('resultContainer').innerHTML = '';
                
                try {
                    const response = await fetch('/test-connection');
                    const data = await response.json();
                    
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    if (response.ok) {
                        // Success
                        document.getElementById('statusContainer').innerHTML = 
                            `<div class="success">✅ Successfully connected to database at ${new Date().toLocaleString()}</div>`;
                        
                        // Display the results in a table
                        if (data.result && data.result.length > 0) {
                            let tableHtml = '<h2>Company Records</h2><table><thead><tr>';
                            
                            // Create table headers from the first record's keys
                            const headers = Object.keys(data.result[0]);
                            headers.forEach(header => {
                                tableHtml += `<th>${header}</th>`;
                            });
                            
                            tableHtml += '</tr></thead><tbody>';
                            
                            // Add rows for each record
                            data.result.forEach(record => {
                                tableHtml += '<tr>';
                                headers.forEach(header => {
                                    let cellValue = record[header];
                                    // Format dates nicely if they look like dates
                                    if (cellValue && typeof cellValue === 'string' && 
                                        cellValue.includes('T') && cellValue.includes('Z')) {
                                        try {
                                            cellValue = new Date(cellValue).toLocaleString();
                                        } catch (e) {
                                            // If it's not actually a date, keep original
                                        }
                                    }
                                    tableHtml += `<td>${cellValue || ''}</td>`;
                                });
                                tableHtml += '</tr>';
                            });
                            
                            tableHtml += '</tbody></table>';
                            document.getElementById('resultContainer').innerHTML = tableHtml;
                        } else {
                            document.getElementById('resultContainer').innerHTML = 
                                '<p>No records found in the companies table.</p>';
                        }
                    } else {
                        // Error
                        document.getElementById('statusContainer').innerHTML = 
                            `<div class="error">❌ Failed to connect to database: ${data.error}</div>`;
                    }
                } catch (error) {
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    // Connection or JavaScript error
                    document.getElementById('statusContainer').innerHTML = 
                        `<div class="error">❌ Error: ${error.message}</div>`;
                }
            });
        </script>
    </div>
</body>
</html>